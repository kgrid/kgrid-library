package org.uofm.ot.services;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.uofm.ot.exception.ObjectTellerException;
import org.uofm.ot.fedoraAccessLayer.*;
import org.uofm.ot.fusekiAccessLayer.FusekiService;
import org.uofm.ot.knowledgeObject.*;
import org.uofm.ot.model.OTUser;
import org.uofm.ot.model.User;
import org.uofm.ot.model.UserProfile;

import java.util.ArrayList;
import java.util.List;


@Service
public class KnowledgeObjectService {

	@Autowired
	private IdService idService;
	
	@Autowired
	private FusekiService fusekiService;
	
	@Autowired
	private GetFedoraObjectService getFedoraObjectService;
	
	@Autowired
	private EditFedoraObjectService editFedoraObjectService;
	
	@Autowired
	private DeleteFedoraResourceService deleteFedoraResourceService;
	
	@Autowired
	private CreateFedoraObjectService createFedoraObjectService;
	
	public KnowledgeObject getKnowledgeObject(ArkId arkId) throws ObjectTellerException {

		KnowledgeObject object = fusekiService.getKnowledgeObject(arkId);
		if(object != null) {
			List<Citation> citations = fusekiService.getObjectCitations(arkId);
			object.getMetadata().setCitations(citations);
		}
		return object;
	}
	
	public KnowledgeObject editObject(KnowledgeObject newObject, ArkId arkId) throws ObjectTellerException {

		addOrEditMetadata(arkId, newObject.getMetadata());
		editPayload(arkId, newObject.getPayload());
		editInputMessageContent(arkId, newObject.getInputMessage());
		editOutputMessageContent(arkId, newObject.getOutputMessage());
		KnowledgeObject updatedObject = getCompleteKnowledgeObject(arkId);
		return updatedObject ; 
	}
	
	public void deleteObject(ArkId arkId) throws ObjectTellerException {
		deleteFedoraResourceService.deleteObject(arkId.getFedoraPath());
	}
	
	public List<KnowledgeObject> getKnowledgeObjects(boolean published) throws ObjectTellerException {
		List<KnowledgeObject> knowledgeObjects = null;
		knowledgeObjects = fusekiService.getFedoraObjects(published);
		return knowledgeObjects;
	}
	
	public Integer getNumberOfPublishedObjects() throws ObjectTellerException {
		return fusekiService.getNumberOfPublishedObjects();
	}
	
	public KnowledgeObject getCompleteKnowledgeObject(ArkId arkId) throws ObjectTellerException {

        String uri = arkId.getFedoraPath();
		
		KnowledgeObject object = getKnowledgeObject(arkId);
		
		Payload payload = fusekiService.getPayloadProperties(uri);
		
		payload.setContent(getPayloadContent(uri));
		
		object.setPayload(payload);

		object.setLogData(getProvData(arkId));

		object.setInputMessage(getInputMessageContent(arkId));

		object.setOutputMessage(getOutputMessageContent(arkId));
		
		return object;
	}
	
	public Metadata addOrEditMetadata(ArkId arkId, Metadata newMetadata) throws ObjectTellerException {

        String uri = arkId.getFedoraPath();

		editFedoraObjectService.editObjectMetadata(newMetadata,uri);
	//	editFedoraObjectService.toggleObject(uri, newMetadata.isPublished() ? "yes" : "no");
	


		List<Citation> oldCitations = fusekiService.getObjectCitations(arkId);

		if(newMetadata != null && newMetadata.getCitations() != null) {
			List<Citation> editCitations = new ArrayList<Citation>();

			boolean firstCitation = true ; 
			// To add new citations
			for (Citation citation : newMetadata.getCitations()) {
				if(citation.getCitation_id() == null && citation.getCitation_title() != null && citation.getCitation_at() != null ) {

					if(firstCitation) {
						boolean citationParentExist = createFedoraObjectService.checkIfObjectExists(uri+"/"+ChildType.CITATIONS.getChildType());

						if(!citationParentExist) 
							createFedoraObjectService.createContainer(uri+"/"+ChildType.CITATIONS.getChildType(), null);

						firstCitation = false ;

					}
					
					String location = createFedoraObjectService.createContainerWithAutoGeneratedName(uri+"/"+ChildType.CITATIONS.getChildType(), null);

					citation.setCitation_id(location);

					createFedoraObjectService.addCitationProperties(citation, uri+"/"+ChildType.CITATIONS.getChildType()+"/"+location, null);
				} else {
					if(citation.getCitation_id() != null )
						editCitations.add(citation);
				}
			}
			
			editFedoraObjectService.editCitations(uri,editCitations);
			oldCitations.removeAll(editCitations);
		}
		
		if(!oldCitations.isEmpty()){
			for (Citation citation : oldCitations) {
				deleteFedoraResourceService.deleteObjectCitation(uri, citation.getCitation_id());
			}		
		}
		
		return getKnowledgeObject(arkId).getMetadata() ;
	}
	
	public KnowledgeObject createKnowledgeObject(KnowledgeObject knowledgeObject, OTUser loggedInUser, String libraryURL) throws ObjectTellerException {
		return createFedoraObjectService.createObject(knowledgeObject, loggedInUser, libraryURL, null);
	}

	public KnowledgeObject createFromExistingArkId(KnowledgeObject knowledgeObject,String libraryURL, ArkId existingArkId) throws ObjectTellerException {
		
		// TODO: Check other option for Dummy User
		UserProfile profile = new UserProfile("MANUAL", "IMPORT");
		OTUser loggedInUser = new OTUser(null, null, null, profile); 
		return createFedoraObjectService.createObject(knowledgeObject, loggedInUser,libraryURL ,existingArkId);

	}

	public String getInputMessageContent(ArkId arkId) throws ObjectTellerException{
		return getFedoraObjectService.getObjectContent(arkId.getFedoraPath(), ChildType.INPUT.getChildType());
	}
	
	public String getOutputMessageContent(ArkId arkId) throws ObjectTellerException{
		return getFedoraObjectService.getObjectContent(arkId.getFedoraPath(), ChildType.OUTPUT.getChildType());
	}
	
	public String getPayloadContent(String objectURI) throws ObjectTellerException{
		return getFedoraObjectService.getObjectContent(objectURI, ChildType.PAYLOAD.getChildType());
	}
	
	public String getProvData(ArkId arkId) throws ObjectTellerException{
		String provDataPart1 = fusekiService.getObjectProvProperties(arkId.getFedoraPath());

		String provDataPart2 = fusekiService.getObjectProvProperties(arkId.getFedoraPath()+"/"+ChildType.LOG.getChildType()+"/"+ChildType.CREATEACTIVITY.getChildType());

		return provDataPart1 + provDataPart2 ; 
	}
	
	public void editInputMessageContent(ArkId arkId,String inputMessage) throws ObjectTellerException{
		editFedoraObjectService.putBinary(inputMessage, arkId.getFedoraPath(), ChildType.INPUT.getChildType(), null);
	}
	
	public void editOutputMessageContent(ArkId arkId,String outputMessage) throws ObjectTellerException{
		editFedoraObjectService.putBinary(outputMessage, arkId.getFedoraPath(), ChildType.OUTPUT.getChildType(), null);
	}
	
	public Payload getPayload(ArkId arkId) throws ObjectTellerException {
		Payload payload = fusekiService.getPayloadProperties(arkId.getFedoraPath());
		payload.setContent(getPayloadContent(arkId.getFedoraPath()));
		return payload ;
	}
	
	public void editPayload(ArkId arkId,Payload payload) throws ObjectTellerException {
		editFedoraObjectService.putBinary( payload.getContent(), arkId.getFedoraPath(), ChildType.PAYLOAD.getChildType(),null);
		editFedoraObjectService.editPayloadMetadata(payload,arkId.getFedoraPath());
	}
	
	public void patchKnowledgeObject(KnowledgeObject knowledgeObject,ArkId arkId) throws ObjectTellerException {
		if(knowledgeObject != null){
			if(knowledgeObject.getMetadata() != null ) {
				String param = knowledgeObject.getMetadata().isPublished() ? "yes":"no";
				editFedoraObjectService.toggleObject(arkId.getFedoraPath(), param);
			}
		}
	}

	public boolean exists(ArkId arkId) throws ObjectTellerException {
		return getFedoraObjectService.checkIfObjectExists(arkId.getFedoraPath());
	}

	public void publishKnowledgeObject(ArkId arkId, boolean isToBePublished, User loggedInUser) throws ObjectTellerException {

		KnowledgeObject ko = getKnowledgeObject(arkId);

		if ( ko == null ) {
			throw new ObjectTellerException("Unable to retrieve knowledge object: " + arkId.getArkId());
		}

		editFedoraObjectService.toggleObject(arkId.getFedoraPath(), isToBePublished? "yes" : "no" );

		List<String> metadata = idService.createBasicMetadata(loggedInUser.getFullName(), ko.getMetadata().getTitle());
		if(isToBePublished) {
			idService.publish(arkId, metadata);
		} else {
			idService.retract(arkId, metadata);
		}

	}
}
